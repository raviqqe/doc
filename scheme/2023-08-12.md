# Stak Scheme

[@raviqqe](https://github.com/raviqqe)

August 13, 2023

---

# Contents

- Overview
- Virtual Machine (VM)
- Bytecodes
- Compiler

---

# Overview

- Stak Scheme
  - There is a typo. (no "c")
- Scheme runs on a machine stack.
  - No `std` and no `alloc`
- Compiler written in Scheme + VM written in Rust
- Based on [Ribbit Scheme][ribbit]
  - But Stak VM does not pursue portability.
  - The VM is specialized for implementation in system programming languages.

---

# Virtual Machine (VM)

- Stack machine
- Von Neumann architecture (?)

---

# Virtual Machine (VM)

## State

- Program counter
  - Points to bytecodes running currently
- Stack
  - Represented as a list
- Symbols
  - Represented as a list of pairs
- Heap (as an unboxed array)
  - If someone wants to run a VM on actual heap, they can simply box it with, for example, `Box::new()`.

---

# Bytecodes

- Mostly borrowed from [Ribbit Scheme][ribbit]
- Represented as lists on heap
- Core instructions
  - `call`: Tail and non-tail calls
  - `set`: Set global/local variables
  - `get`: Get global/local variables
  - `constant`: Push constants
  - `if`
- Primitives: `rib`, `cons`, `skip`, ...

---

# Compiler

## Main routine

```scheme
(write-target (encode (compile (expand (read-source)))))
```

- `read-source` reads S-expressions from stdin.
- `expand` expands syntax sugar (e.g. `let*`, `letrec`, etc.)
- `compile` compiles S-expressions into bytecodes.
- `encode` encodes bytecodes on memory into bytes.
- `write-target` writes encoded bytecodes into stdout.

---

# Next tasks...

- Scheme in Rust
  - More language features in the bytecode compiler
    - Closures
    - Slot variables

---

# Summary

- Building a VM is fun (again.)

[ribbit]: https://github.com/udem-dlteam/ribbit/tree/main
