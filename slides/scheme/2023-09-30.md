# Hygienic macro on Stak Scheme

[@raviqqe](https://github.com/raviqqe)

September 30, 2023

---

# Contents

- Hygienic macro
  - Overview
  - Implementation
- Progress
  - New features
  - Next tasks...

---

# Hygienic macro

---

# Overview

- Macros transcribes a soruce code into another source code.
- Hygienic macros must not:
  - Insert a binding that captures a reference not introduced by the macro itself.
  - Insert a reference that is captured by a binding not introduced by the macro itself.

---

# Examples

## Let binding

`(let ((x e1)) e2)` is equivalent to `((lambda (x) e2) e1)`.

### Definition

```scheme
(define-syntax foo
  (syntax-rules
    ((_ ((x e1)) e2)
      ((lambda (x) x) e1))))
```

---

# Examples

## Let binding

### Capturing a reference not introduced by the macro

```scheme
(define y 42)

(let ((x x)) x)
```

---

# Examples

## Let binding

### Captured by a binding not introduced by the macro

```scheme
(define y 42)

(let ((x x)) x)
```

---

## Stak Scheme

- It had only the "dirty" `syntax-rules` macro.
- Now, it's hygienic!

---

## References

- [BiwaSchemeにhygienic macroを入れる | 定期ミートアップ 第7回 yhara](https://scrapbox.io/prog-lang-sys-ja/%E5%AE%9A%E6%9C%9F%E3%83%9F%E3%83%BC%E3%83%88%E3%82%A2%E3%83%83%E3%83%97_%E7%AC%AC7%E5%9B%9E_yhara)
- [Macros That Work (a paper)](https://www.researchgate.net/publication/220997237_Macros_That_Work)
- [Hygienic Macros Through Explicit Renaming](https://dl.acm.org/doi/pdf/10.1145/1317265.1317269)
- [5.2 Hygienic macros | Gauche](https://practical-scheme.net/gauche/man/gauche-refe/Hygienic-macros.html)
- [Hygienic macro | Wikipedia](https://en.wikipedia.org/wiki/Hygienic_macro)

---

# Progress

---

# Other new features

- Hygienic `syntax-rules`
- Quasi-quotation
- `read` and `write` procedures
- Symbol table GC
- Ports and EOF objects

---

# Next tasks...

- `apply` procedure
  - [Ribbit Scheme][ribbit] implemented it as a primitive.
- Record type
- `cond-expand`
- Self-hosting

---

# Summary

- Building Scheme is fun (again.)

[ribbit]: https://github.com/udem-dlteam/ribbit/tree/main
