# Progress report in Pen programming language

## July 17th, 2022

[@raviqqe](https://github.com/raviqqe)

---

# Agenda

- Progress report
  - Reference counting optimization
  - C calling convention (no progress)
- Next plans

---

# Progress report

---

# Reference counting optimization

- Fibonacci number is 25% faster than the previous version!
  - Now, it's 2 times slower than Rust...
- Static pointer tagging was preventing direct calls of global functions.
  - Pointer tagging and untagging were not removed by foo.
  - Clang does it but at the level of CIL?
  - Its removal also led to simpler static memory block check.

---

## Benchmark

---

# Record update benchmark

- The previous result had several performance bugs!
  - Inefficient map literal compilation
  - Non-unique references

## Configuration

- Hash map initialization with many entries
- A number of entries: 100,000
- Key type: 64-bit floating point number

---

## Results

- Pen is 6 ~ 7 times slower than Rust currently...

### Pen

```sh
> hyperfine -w 3 ./app
Benchmark 1: ./app
  Time (mean ± σ):     274.0 ms ±   2.7 ms    [User: 206.7 ms, System: 16.8 ms]
  Range (min … max):   269.6 ms … 279.3 ms    10 runs
```

### `im-rs` in Rust

- `HashMap::insert(&mut self, k: K, v: V) -> Option<V>`

```sh
test hashmap_insert_mut_100000 ... bench:  34,869,571 ns/iter (+/- 4,337,627)
```

---

# Next plans

- Proper C calling convention in FFI [#444](https://github.com/pen-lang/pen/issues/444)
  - Compiling to MLIR?
- Application development?
  - WebGL???

---

# Summary

- Progress
  - Reference counting optimization
- Next plans
  - Record unboxing
