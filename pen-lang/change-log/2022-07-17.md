# Progress report in Pen programming language

## July 17th, 2022

[@raviqqe](https://github.com/raviqqe)

---

# Agenda

- Progress report
  - Reference counting optimization
  - C calling convention (no progress)
- Next plans

---

# Progress report

---

# Reference counting optimization

- Reference counting can use relaxed atomic or non-atomic operations sometimes.
  - For only references never shared by multiple threads
- Part of [the Perceus reference counting algorithm](https://www.microsoft.com/en-us/research/publication/perceus-garbage-free-reference-counting-with-reuse/)

---

## Benchmark

---

# Record update benchmark

- The previous result had several performance bugs!
  - Inefficient map literal compilation
  - Non-unique references

## Configuration

- Hash map initialization with many entries
- A number of entries: 100,000
- Key type: 64-bit floating point number

---

## Results

- Pen is 6 ~ 7 times slower than Rust currently...

### Pen

```sh
> hyperfine -w 3 ./app
Benchmark 1: ./app
  Time (mean ± σ):     274.0 ms ±   2.7 ms    [User: 206.7 ms, System: 16.8 ms]
  Range (min … max):   269.6 ms … 279.3 ms    10 runs
```

### `im-rs` in Rust

- `HashMap::insert(&mut self, k: K, v: V) -> Option<V>`

```sh
test hashmap_insert_mut_100000 ... bench:  34,869,571 ns/iter (+/- 4,337,627)
```

---

# Next plans

- Proper C calling convention in FFI [#444](https://github.com/pen-lang/pen/issues/444)
  - Compiling to MLIR?
- Application development?
  - WebGL???

---

# Summary

- Progress
  - Reference counting optimization
- Next plans
  - Record unboxing
