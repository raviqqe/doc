# Progress report in Pen programming language

## October 16, 2022

[@raviqqe](https://github.com/raviqqe)

---

# Agenda

- Progress report
  - `Reflect` package
  - `Test` package improvements
  - C calling convention
  - Compiler optimization
- Next plans

---

# Progress report

---

# Optimization of stack element order in CPS

In `Add`,

```log
504: 42 00 00 91  	add	x2, x2, #0
508: fd 7b 45 a9  	ldp	x29, x30, [sp, #80]
50c: 29 01 08 8b  	add	x9, x9, x8
510: 08 81 00 91  	add	x8, x8, #32         <-
514: f6 57 43 a9  	ldp	x22, x21, [sp, #48]
518: 28 29 01 6d  	stp	d8, d10, [x9, #16]  <-
51c: 29 05 00 fd  	str	d9, [x9, #8]        <-
520: 34 01 00 f9  	str	x20, [x9]           <-
524: 68 06 00 f9  	str	x8, [x19, #8]       <-
528: f4 4f 44 a9  	ldp	x20, x19, [sp, #64]
```

---

At the beginning of `Add`'s first continuation,

```log
2a70: ff 03 01 d1  	sub	sp, sp, #64
2a74: 08 04 40 f9  	ldr	x8, [x0, #8]              <-
2a78: 09 00 00 90  	adrp	x9, 0x2000 <__k_1a+0x8>
2a7c: e9 23 01 6d  	stp	d9, d8, [sp, #16]
2a80: 08 40 60 1e  	fmov	d8, d0
2a84: f4 4f 02 a9  	stp	x20, x19, [sp, #32]
2a88: f3 03 00 aa  	mov	x19, x0
2a8c: 08 81 00 d1  	sub	x8, x8, #32               <-
2a90: fd 7b 03 a9  	stp	x29, x30, [sp, #48]
2a94: 08 04 00 f9  	str	x8, [x0, #8]              <-
2a98: 23 01 40 f9  	ldr	x3, [x9]
```

---

At the end of `Add`'s first continuation,

```log
2ae4: 42 00 00 91  	add	x2, x2, #0
2ae8: fd 7b 43 a9  	ldp	x29, x30, [sp, #48]
2aec: 08 81 00 91  	add	x8, x8, #32         <-
2af0: 68 06 00 f9  	str	x8, [x19, #8]       <-
2af4: 28 69 28 fc  	str	d8, [x9, x8]        <-
2af8: 68 06 40 f9  	ldr	x8, [x19, #8]       <-
2afc: e9 23 41 6d  	ldp	d9, d8, [sp, #16]
2b00: 08 21 00 91  	add	x8, x8, #8          <-
2b04: 68 06 00 f9  	str	x8, [x19, #8]       <-
2b08: f4 4f 42 a9  	ldp	x20, x19, [sp, #32]
```
