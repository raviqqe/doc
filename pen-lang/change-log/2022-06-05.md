# Progress report in Pen programming language

## June 4th, 2022

[@raviqqe](https://github.com/raviqqe)

---

# Agenda

- Progress report
  - Heap reuse in record updates
- Next plans

---

# Progress report

---

# Heap reuse in record updates

- Programs reuses memory blocks if record updates are performed on unique references.
- Part of [the Perceus reference counting algorithm](https://www.microsoft.com/en-us/research/publication/perceus-garbage-free-reference-counting-with-reuse/).
- Only applicable to record updates
  - One-field records are planned to be unboxed.
- Similar to `Arc::make_mut()` in Rust

```pen
type foo {
  bar number
  baz number
}

f = \(x foo) foo {
  # Reuse a memory block originally allocated for x if the reference is unique.
  foo{...x, bar: 42}
}
```

---

# Benchmark

- Map insertion
- Element count: 100,000

Before:

```sh
> time ./app
app  0.94s user 0.08s system 95% cpu 1.064 total
```

After:

```sh
> time ./app

```

---

# Others

- The standard `Sql` package
- FFI improvements
  - Conversion between lists in Pen and async streams in Rust
  - Type casting of `any` type values

---

# Next plans

- Reference counting optimization
  - Relaxed atomic reference counting with sync bit [#468](https://github.com/pen-lang/pen/issues/468)
  - Unboxing small records [#671](https://github.com/pen-lang/pen/issues/671)
- Proper C calling convention in FFI [#444](https://github.com/pen-lang/pen/issues/444)
  - Compiling to MLIR?

---

# Summary

- Progress
  - Heap reuse in record updates
- Next plans
  - Relaxed atomic reference counting
  - Record unboxing
