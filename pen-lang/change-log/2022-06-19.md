# Progress report in Pen programming language

## June 19th, 2022

[@raviqqe](https://github.com/raviqqe)

---

# Agenda

- Progress report
  - Relaxed atomic operations in reference counting
- Next plans

---

# Progress report

---

# Relaxed atomic operations in reference counting

- Reference counting can use atomic operations with no ordering when references are never shared by multiple threads.
- Part of [the Perceus reference counting algorithm](https://www.microsoft.com/en-us/research/publication/perceus-garbage-free-reference-counting-with-reuse/)

---

## Benchmark

- Conway's game of life
- Size: 20 x 40
- Iteration: 1,000
- ~30% improvement in time

Before:

```sh
> time ./app
./app  15.56s user 0.08s system 99% cpu 15.646 total
```

After:

```sh
> time ./app
./app  10.26s user 0.14s system 97% cpu 10.628 total
```

---

# Next plans

- Reference counting optimization
  - Unboxing small records [#671](https://github.com/pen-lang/pen/issues/671)
- Proper C calling convention in FFI [#444](https://github.com/pen-lang/pen/issues/444)
  - Compiling to MLIR?

---

# Summary

- Progress
  - Heap reuse in record updates
- Next plans
  - Record unboxing

---

# Record update benchmark

## No uniqueness check

```sh
> for _ in $(seq 5); do time ./app; done
./app  7.98s user 0.26s system 99% cpu 8.302 total
./app  7.70s user 0.24s system 99% cpu 7.991 total
./app  7.71s user 0.29s system 99% cpu 8.052 total
./app  7.76s user 0.31s system 99% cpu 8.117 total
./app  8.10s user 0.26s system 99% cpu 8.423 total
```

## Acquire ordering

```sh
> for _ in $(seq 5); do time ./app; done
./app  7.68s user 0.28s system 99% cpu 8.019 total
./app  7.57s user 0.32s system 99% cpu 7.950 total
./app  7.63s user 0.22s system 99% cpu 7.905 total
./app  7.58s user 0.26s system 99% cpu 7.899 total
./app  7.59s user 0.27s system 99% cpu 7.933 total
```

## Relaxed (buggy) ordering

```sh
> for _ in $(seq 5); do time ./app; done
./app  7.46s user 0.30s system 99% cpu 7.817 total
./app  7.41s user 0.24s system 99% cpu 7.703 total
./app  7.51s user 0.26s system 99% cpu 7.823 total
./app  7.47s user 0.26s system 99% cpu 7.775 total
./app  7.42s user 0.26s system 99% cpu 7.734 total
```

## Relaxed (correct) ordering

```sh
> for _ in $(seq 5); do time ./app; done
./app  7.60s user 0.26s system 99% cpu 7.930 total
./app  7.50s user 0.29s system 99% cpu 7.860 total
./app  7.60s user 0.27s system 99% cpu 7.940 total
./app  7.56s user 0.25s system 99% cpu 7.865 total
./app  7.55s user 0.27s system 99% cpu 7.878 total
```
